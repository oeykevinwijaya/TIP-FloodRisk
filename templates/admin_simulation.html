<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin Flood Prediction Page</title>
        <link
        href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
        rel="stylesheet"
        />  
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    </head>
    <body class="bg-gray-100 font-sans leading-normal tracking-normal">
        <!-- Menu Button -->
        <button
            id="sidebar-toggle"
            class="text-white focus:outline-none bg-gray-700 p-2.5 fixed top-2.5 left-2.5 z-30"
        >
            <svg class="fill-current h-6 w-6" viewBox="0 0 24 24">
                <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"></path>
            </svg>
        </button>

        <!-- Sidebar -->
        <div
            id="sidebar"
            class="transform -translate-x-full fixed inset-y-0 left-0 w-64 space-y-6 py-7 px-2 z-20 bg-white shadow-md transition-transform duration-500 ease-in-out"
            style="will-change: transform"
        >
            <a href="#" class="text-gray-800 flex items-center space-x-2 px-4">
                <span class="text-2xl font-medium mt-10">Menu</span>
            </a>
            <!-- Sidebar content -->
            <nav class="text-black text-base">
                <a
                    href="admin_page_alert.html"
                    class="flex items-center justify-center hover:border-l-4 hover:border-gray-700 px-10 py-5 border-t border-b border-gray-300 text-sm"
                >
                    User Alter Management
                </a>
                <a
                href="admin_simulation.html"
                class="flex items-center justify-center hover:border-l-4 hover:border-gray-700 px-10 py-5 border-t border-b border-gray-300 text-sm"
                >
                    Flood Prediction
                </a>
                <a
                    href="data_management.html"
                    class="flex items-center justify-center hover:border-l-4 hover:border-gray-700 px-10 py-5 border-t border-b border-gray-300 text-sm"
                >
                    Data Management
                </a>
                <a
                    href="admin_access.html"
                    class="flex items-center justify-center hover:border-l-4 hover:border-gray-700 px-10 py-5 border-t border-b border-gray-300 text-sm"
                >
                    Admin Management
                </a>
                <a
                    href="email.html"
                    class="flex items-center justify-center hover:border-l-4 hover:border-gray-700 px-10 py-5 border-t border-b border-gray-300 text-sm"
                >
                    Email
                </a>
                <a
                    href="weather_forecast.html"
                    class="flex items-center justify-center hover:border-l-4 hover:border-gray-700 px-10 py-5 border-t border-b border-gray-300 text-sm mt-20"
                >
                    Home Page
                </a>
            </nav>
        </div>

        <!-- Header -->
        <nav class="bg-gray-700 p-4 fixed w-full z-10">
            <div class="flex items-center justify-between flex-wrap">
                <div class="flex items-center flex-shrink-0 text-white mr-6">
                    <span class="font-semibold text-xl tracking-tight mx-14"
                        >Hong Kong Flood</span
                    >
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main
        class="p-8 transition-padding duration-500 ease-in-out"
        id="main-content"
        style="will-change: padding"
        >        
            <!-- User Management title -->
            <div
                class="mx-10 mt-8 p-5 border-b border-gray-700 font-bold text-xl"
            >
                Flood Prediction Simulation
            </div>
            <!-- User Management table-->
            <div class="mx-10 mt-8 p-5 border-b border-gray-700">
                <form id="predictionForm" class="flex flex-col items-left gap-4">
                    <div class="flex items-center gap-2 w-full max-w-lg">
                        <label for="date" class="block text-lg font-medium text-gray-700">Select Date:</label>
                        <input type="date" id="date" name="date" required class="flex-1 min-w-0 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <button type="submit" class="w-1/2 max-w-xs px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Predict
                    </button>
                </form>
                <div id="predictionResult" class="mt-4 text-lg font-medium text-left w-full"></div>
            </div>
        
            <!-- Chart Container -->
            <div id="chartContainer" class="mx-10 mt-8 p-5 border-b border-gray-700 text-center" style="display: none;">
                <h2 class="text-xl font-bold">Flood Prediction Chart</h2>
                <p>The chart displays the probability of flooding over a three-day period.</p>
                <canvas id="floodPredictionChart" class="mx-auto" width="800" height="300"></canvas>
            </div>
        </main>
        
        <script>
        let floodChart;  // Store the chart object for later destruction

        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('floodPredictionChart');
            

            const form = document.getElementById('predictionForm');
            form.onsubmit = function(event) {
                event.preventDefault();
                const date = document.getElementById('date').value;
                fetch(`/predict_flood_range?date=${date}`)
                    .then(response => response.json())
                    .then(data => {
                        const chartContainer = document.getElementById('chartContainer');
                        const ctx = document.getElementById('floodPredictionChart').getContext('2d');

                        chartContainer.style.display = 'block';

                        // Destroy the existing chart if it exists
                        if (floodChart) {
                            floodChart.destroy();
                        }

                        floodChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.map(item => item.date),
                                datasets: [{
                                    label: 'Flood Probability (%)',
                                    data: data.map(item => item.probability),
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: false,  
                                maintainAspectRatio: false, 
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        const resultDiv = document.getElementById('predictionResult');
                        updateResultDisplay(data, resultDiv); // Function to handle result display
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        document.getElementById('predictionResult').textContent = 'Error fetching prediction.';
                        document.getElementById('predictionResult').className = "mt-4 text-lg font-medium text-red-500";
                    });
            };
        });

        function updateResultDisplay(data, resultDiv) {
            if (data[1] && data[1].probability !== null) {
                const probability = parseFloat(data[1].probability); // Use the probability of the selected date
                const rainfall = parseFloat(data[1].rainfall); // Use the rainfall of the selected date
                let message = `Probability: ${probability}%, Rainfall: ${rainfall}mm`;
                resultDiv.textContent = message;

                if (probability < 50) {
                    message = 'No flooding issues detected. Probability: ' + data[1].probability + '%. Rainfall: ' + data[1].rainfall + 'mm';
                    resultDiv.className = "mt-4 text-lg font-medium text-green-500";
                } else if (probability >= 50 && probability <= 85) {
                    message = 'Warning level of flooding. Probability: ' + data[1].probability + '%. Rainfall: ' + data[1].rainfall + 'mm';
                    resultDiv.className = "mt-4 text-lg font-medium text-yellow-500";
                } else if (probability > 85) {
                    message = 'Danger level of flooding. Probability: ' + data[1].probability + '%. Rainfall: ' + data[1].rainfall + 'mm';
                    resultDiv.className = "mt-4 text-lg font-medium text-red-500";
                }
                resultDiv.textContent = message;
            } else {
                resultDiv.textContent = 'No data available for the selected date.';
                resultDiv.className = "mt-4 text-lg font-medium text-gray-500";
            };
        }


        </script>
            
            
            
            
        <script
            type="module"
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
        ></script>
        <script
            nomodule
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
        ></script>
        <script src="{{ url_for('static', filename='script.js') }}"></script>
        <script src="{{ url_for('static', filename='mainpage.js') }}"></script>
    </body>
</html>
