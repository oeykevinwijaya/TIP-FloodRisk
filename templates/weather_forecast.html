<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Weather Forecast</title>
        <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    
    <!-- style for bar chart -->
    <style>
        .chart-container {
            width: 90%;
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .footer {
            text-align: center;
            font-weight: bold;
            margin-top: 30px;
        }

        .social-button {
            margin: 5px;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }

        .facebook {
            background-color: #3b5998;
            color: white;
        }

        .twitter {
            background-color: #55acee;
            color: white;
        }
    </style>

    <body class="font-sans leading-normal tracking-normal bg-gray-100">
        <!-- Menu Button -->
        <button
            id="sidebar-toggle"
            class="text-white focus:outline-none bg-gray-700 p-2.5 fixed top-2.5 left-2.5 z-30"
        >
            <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"></path>
            </svg>
        </button>

        <!-- Sidebar -->
        <div
            id="sidebar"
            class="fixed inset-y-0 left-0 z-20 w-64 px-2 space-y-6 transition-transform duration-500 ease-in-out transform -translate-x-full bg-white shadow-md py-7"
            style="will-change: transform"
        >
            <a href="#" class="flex items-center px-4 space-x-2 text-gray-800">
                <span class="mt-10 text-2xl font-medium">Menu</span>
            </a>
            <!-- Sidebar content -->
            <nav class="text-base text-black">
                <a
                    href="warning.html"
                    class="flex items-center justify-center px-10 py-5 text-sm border-t border-b border-gray-300 hover:border-l-4 hover:border-gray-700"
                >
                    Warning
                </a>
                <a
                    href="weather_forecast.html"
                    class="flex items-center justify-center px-10 py-5 text-sm border-t border-b border-gray-300 hover:border-l-4 hover:border-gray-700"
                >
                    Weather Forecast
                </a>
                <a
                    href="history.html"
                    class="flex items-center justify-center px-10 py-5 text-sm border-t border-b border-gray-300 hover:border-l-4 hover:border-gray-700"
                >
                    Historical data
                </a>
                <a
                    href="faq.html"
                    class="flex items-center justify-center px-10 py-5 text-sm border-t border-b border-gray-300 hover:border-l-4 hover:border-gray-700"
                >
                    FAQ
                </a>
                <a
                    href="contact.html"
                    class="flex items-center justify-center px-10 py-5 text-sm border-t border-b border-gray-300 hover:border-l-4 hover:border-gray-700"
                >
                    Contact
                </a>
                <a
                    href="noti.html"
                    class="flex items-center justify-center px-10 py-5 text-sm border-t border-b border-gray-300 hover:border-l-4 hover:border-gray-700"
                >
                    Notification Setting
                </a>
                <a
                    href="admin_access.html"
                    class="flex items-center justify-center px-10 py-5 text-sm border-t border-b border-gray-300 hover:border-l-4 hover:border-gray-700"
                >
                    Admin Page
                </a>
                <a
                    href="loginadmin.html"
                    class="flex items-center justify-center px-10 py-5 mt-20 text-sm border-t border-b border-gray-300 hover:border-l-4 hover:border-gray-700"
                >
                    Admin Login
                </a>

            </nav>
        </div>

        <!-- Header -->
        <nav class="fixed z-10 w-full p-4 bg-gray-700">
            <div class="flex flex-wrap items-center justify-between">
                <div class="flex items-center flex-shrink-0 mr-6 text-white">
                    <span class="text-xl font-semibold tracking-tight mx-14"
                        >Hong Kong Flood</span
                    >
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main
            class="p-8 duration-500 ease-in-out transition-padding"
            id="main-content"
            style="will-change: padding"
        >
            <!-- Top black area-->
            <div class="h-[55px] bg-gray-700"></div>

            <!-- Title -->
            <header class="container mt-20 text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">9-day Weather Forecast</h1>
            </header>

            <!-- User Management table-->
            <div class="p-3 mx-8 mt-5 overflow-hidden">
            <!-- Main Forecast -->
            <div class="container mx-auto w-3/4 bg-white shadow-md rounded-md p-4">
                <div class="overflow-x-auto">
                    <table class="w-full bg-white">
                        <thead>
                            <tr class="w-full bg-gray-300 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-4 text-center">Day</th>
                                <th class="py-3 px-4 text-center">Temperature</th>
                                <th class="py-3 px-4 text-center">Relative Humidity</th>
                                <th class="py-3 px-4 text-center">Rain Probability</th>
                                <th class="py-3 px-4 text-center">Condition</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm" id="forecast-table-body">
                            <!-- Dynamic rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

            <!-- Bar Chart for Max and Min Temperatures -->
            <div class="chart-container">
                <h2 class="title mt-10">Highest (°C) and Lowest (°C) Temperatures</h2>
                <canvas id="temperatureChart"></canvas>
            </div>

            <!-- Bar Chart for Max and Min Relative Humidity -->
            <div class="chart-container">
                <h2 class="title mt-10">Highest (%) and Lowest (%) Relative Humidity</h2>
                <canvas id="humidityChart"></canvas>
            </div>

            <!-- Alter history title-->
            <div
                class="pb-2 pl-5 mx-10 mt-10 text-xl font-bold border-b border-gray-700"
            >
                Alert History
            </div>
            <!-- History data-->
            <div class="mx-10 overflow-hidden">
                <!-- Alert Item -->
                <div
                    class="flex items-center px-4 py-1 mt-3 space-x-3 border border-gray-500 rounded"
                >
                    <div class="text-red-500">
                        <ion-icon name="alert-circle" size="large"></ion-icon>
                    </div>
                    <p class="flex-grow text-sm font-semibold text-red-500">
                        Heavy Rain Advisory In Effect From Early This Afternoon
                        (03/28) Through This Evening (03/28)
                    </p>
                    <div class="text-gray-700">
                        <ion-icon
                            name="chevron-forward-outline"
                            size="large"
                        ></ion-icon>
                    </div>
                </div>
            </div>
            <!-- History data based on prediction-->
            <div class="mx-10 overflow-hidden">
                {% if prediction == '1' %}
                    <div class="flex items-center px-4 py-1 mt-3 space-x-3 border border-gray-500 rounded">
                        <div class="text-red-500">
                            <ion-icon name="alert-circle" size="large"></ion-icon>
                        </div>
                        <p class="flex-grow text-sm font-semibold text-red-500">
                            High risk of flood. Take necessary precautions.
                        </p>
                    </div>
                {% else %}
                    <div class="flex items-center px-4 py-1 mt-3 space-x-3 border border-gray-300 rounded">
                        <div class="text-green-500">
                            <ion-icon name="checkmark-circle" size="large"></ion-icon>
                        </div>
                        <p class="flex-grow text-sm font-semibold text-green-500">
                            No flooding issues detected.
                        </p>
                    </div>
                {% endif %}
            </div> 
            </div>
        </main>

        <script
            type="module"
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
        ></script>
        <script
            nomodule
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
        ></script>
        <script src="{{ url_for('static', filename='script.js') }}"></script>
        <!-- <script src="mainpage.js"></script> -->
        <script>
            // Function to load weather data from the API
            async function loadWeatherData() {
                const apiUrl = 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=fnd&lang=en';
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching API data:', error);
                    return null;
                }
            }
    
            function formatDate(dateStr) {
                const [year, month, day] = dateStr.match(/(\d{4})(\d{2})(\d{2})/).slice(1, 4);
                const date = new Date(`${year}-${month}-${day}`);
                const formatter = new Intl.DateTimeFormat('en', {
                    day: '2-digit',
                    month: 'short',
                    weekday: 'short'
                });
                const formattedDate = formatter.format(date);
                const [weekday, monthName, dayOfMonth] = formattedDate.replace(',', '').split(' ');
                return `${dayOfMonth} ${monthName} (${weekday})`;
            }
    
            // Function to render table rows from API data
            function renderTableRows(data) {
                const tableBody = document.getElementById('forecast-table-body');
                tableBody.innerHTML = '';
                data.weatherForecast.forEach(item => {
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
    
                    row.innerHTML = `
                        <td class="py-3 px-4 text-center">${formatDate(item.forecastDate)}</td>
                        <td class="py-3 px-4 text-center">${item.forecastMintemp.value} - ${item.forecastMaxtemp.value}°C</td>
                        <td class="py-3 px-4 text-center">${item.forecastMinrh.value} - ${item.forecastMaxrh.value}%</td>
                        <td class="py-3 px-4 text-center">${item.PSR}</td>
                        <td class="py-3 px-4 text-center">${item.forecastWeather}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
    
            // Function to render bar chart for max and min temperatures using Chart.js
            function renderTemperatureChart(data) {
                const labels = data.weatherForecast.map(item => formatDate(item.forecastDate));
                const maxTemps = data.weatherForecast.map(item => parseInt(item.forecastMaxtemp.value));
                const minTemps = data.weatherForecast.map(item => parseInt(item.forecastMintemp.value));
    
                const ctx = document.getElementById('temperatureChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Highest (°C)',
                                data: maxTemps,
                                backgroundColor: '#FD8A8A'
                            },
                            {
                                label: 'Lowest (°C)',
                                data: minTemps,
                                backgroundColor: '#ADC2FF'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Days'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
    
            // Function to render bar chart for max and min relative humidity using Chart.js
            function renderHumidityChart(data) {
                const labels = data.weatherForecast.map(item => formatDate(item.forecastDate));
                const maxRH = data.weatherForecast.map(item => parseInt(item.forecastMaxrh.value));
                const minRH = data.weatherForecast.map(item => parseInt(item.forecastMinrh.value));
    
                const ctx = document.getElementById('humidityChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Highest (%)',
                                data: maxRH,
                                backgroundColor: '#FD8A8A'
                            },
                            {
                                label: 'Lowest (%)',
                                data: minRH,
                                backgroundColor: '#ADC2FF'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Days'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Relative Humidity (%)'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
    
            // Load and render API data on page load
            async function loadAndRenderForecast() {
                const weatherData = await loadWeatherData();
                if (weatherData) {
                    renderTableRows(weatherData);
                    renderTemperatureChart(weatherData);
                    renderHumidityChart(weatherData);
                } else {
                    console.error('Failed to load or parse API data');
                }
            }
    
            // Start the process
            loadAndRenderForecast();
        </script>
    </body>
</html>
